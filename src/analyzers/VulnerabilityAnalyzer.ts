import {
  BaseAnalyzer,
  type AnalyzerContext,
  type AnalyzerResult,
  type Finding,
  type ValidationInput,
  type Severity,
} from '@xorng/template-validator';

/**
 * Security pattern interface
 */
interface SecurityPattern {
  name: string;
  pattern: RegExp;
  message: string;
  suggestion: string;
  severity: Severity;
  cwe?: string;
}

/**
 * Common security vulnerability patterns
 */
const SECURITY_PATTERNS: SecurityPattern[] = [
  {
    name: 'sql-injection',
    pattern: /(?:query|execute|raw)\s*\(\s*[`"'].*\$\{/gi,
    message: 'Potential SQL injection: string interpolation in database query',
    suggestion: 'Use parameterized queries instead of string interpolation',
    severity: 'critical',
    cwe: 'CWE-89',
  },
  {
    name: 'command-injection',
    pattern: /(?:exec|spawn|execSync|spawnSync)\s*\(\s*[`"'].*\$\{/gi,
    message: 'Potential command injection: string interpolation in shell command',
    suggestion: 'Use array arguments for commands and validate/escape all user input',
    severity: 'critical',
    cwe: 'CWE-78',
  },
  {
    name: 'xss-innerhtml',
    pattern: /\.innerHTML\s*=(?!\s*['"`])/gi,
    message: 'Potential XSS: innerHTML assignment with dynamic content',
    suggestion: 'Use textContent or sanitize HTML before assignment',
    severity: 'high',
    cwe: 'CWE-79',
  },
  {
    name: 'xss-document-write',
    pattern: /document\.write\s*\(/gi,
    message: 'Potential XSS: document.write() usage',
    suggestion: 'Avoid document.write() - use DOM manipulation instead',
    severity: 'high',
    cwe: 'CWE-79',
  },
  {
    name: 'eval-usage',
    pattern: /\beval\s*\(/gi,
    message: 'Dangerous eval() usage detected',
    suggestion: 'Avoid eval() - use safer alternatives like JSON.parse() for data',
    severity: 'critical',
    cwe: 'CWE-95',
  },
  {
    name: 'unsafe-regex',
    pattern: /new\s+RegExp\s*\(\s*[^)]*\$\{/gi,
    message: 'Potential ReDoS: dynamic content in RegExp constructor',
    suggestion: 'Validate and sanitize input before using in RegExp',
    severity: 'medium',
    cwe: 'CWE-1333',
  },
  {
    name: 'path-traversal',
    pattern: /(?:readFile|writeFile|readFileSync|writeFileSync|createReadStream|createWriteStream)\s*\([^)]*(?:req\.|params\.|query\.|body\.)/gi,
    message: 'Potential path traversal: user input in file operation',
    suggestion: 'Use path.resolve() with a base directory and validate paths',
    severity: 'high',
    cwe: 'CWE-22',
  },
  {
    name: 'insecure-random',
    pattern: /Math\.random\s*\(\)/gi,
    message: 'Insecure randomness: Math.random() is not cryptographically secure',
    suggestion: 'Use crypto.randomBytes() or crypto.randomUUID() for security purposes',
    severity: 'medium',
    cwe: 'CWE-330',
  },
  {
    name: 'hardcoded-password',
    pattern: /password\s*[:=]\s*['"][^'"]{3,}['"]/gi,
    message: 'Potential hardcoded password detected',
    suggestion: 'Use environment variables or a secure secrets manager',
    severity: 'medium',
    cwe: 'CWE-798',
  },
  {
    name: 'insecure-cors',
    pattern: /(?:Access-Control-Allow-Origin|cors.*origin)\s*[:=]\s*['"][*]['"]|origin:\s*true/gi,
    message: 'Insecure CORS configuration: allowing all origins',
    suggestion: 'Restrict allowed origins to trusted domains',
    severity: 'high',
    cwe: 'CWE-942',
  },
  {
    name: 'missing-csrf',
    pattern: /app\.(?:post|put|delete|patch)\s*\(\s*['"][^'"]+['"]\s*,\s*(?!.*csrf)/gi,
    message: 'Potential missing CSRF protection on state-changing endpoint',
    suggestion: 'Add CSRF token validation for POST/PUT/DELETE endpoints',
    severity: 'high',
    cwe: 'CWE-352',
  },
  {
    name: 'weak-crypto',
    pattern: /(?:createHash|createCipher)\s*\(\s*['"](?:md5|sha1|des)['"]/gi,
    message: 'Weak cryptographic algorithm detected',
    suggestion: 'Use stronger algorithms: SHA-256+ for hashing, AES-256 for encryption',
    severity: 'high',
    cwe: 'CWE-327',
  },
  {
    name: 'prototype-pollution',
    pattern: /\[(?:req\.|params\.|query\.|body\.)[^\]]+\]\s*=/gi,
    message: 'Potential prototype pollution: dynamic property assignment from user input',
    suggestion: 'Validate property names and use Object.hasOwnProperty() checks',
    severity: 'medium',
    cwe: 'CWE-1321',
  },
  {
    name: 'ssrf',
    pattern: /(?:fetch|axios|request|got|http\.get|https\.get)\s*\([^)]*(?:req\.|params\.|query\.|body\.)/gi,
    message: 'Potential SSRF: user input in URL for HTTP request',
    suggestion: 'Validate and whitelist allowed URLs/domains',
    severity: 'medium',
    cwe: 'CWE-918',
  },
];

/**
 * Security vulnerability analyzer
 */
export class VulnerabilityAnalyzer extends BaseAnalyzer {
  private patterns: SecurityPattern[];

  constructor(customPatterns?: SecurityPattern[]) {
    super(
      'vulnerability',
      'Detects common security vulnerabilities',
      'security',
      'high'
    );
    this.patterns = customPatterns || SECURITY_PATTERNS;
  }

  async analyze(input: ValidationInput, context: AnalyzerContext): Promise<AnalyzerResult> {
    const findings: Finding[] = [];
    const lines = input.content.split('\n');
    const filename = input.filename || '';

    for (const pattern of this.patterns) {
      // Reset regex lastIndex for global patterns
      pattern.pattern.lastIndex = 0;

      let match: RegExpExecArray | null;
      while ((match = pattern.pattern.exec(input.content)) !== null) {
        // Find line number
        const beforeMatch = input.content.substring(0, match.index);
        const lineNumber = beforeMatch.split('\n').length;
        const line = lines[lineNumber - 1] || '';

        // Find column
        const lastNewline = beforeMatch.lastIndexOf('\n');
        const column = match.index - (lastNewline + 1);
  private createFinding(type: string, message: string, location: any): Finding {
    return {
      type,
      message,
      location,
      severity: 'high'
    };
  }
            line: lineNumber,
            column,
            code: line.trim(),
            suggestion: pattern.suggestion,
            type: 'security',
            metadata: pattern.cwe ? { cwe: pattern.cwe } : undefined,
          }
        ));

        // Prevent infinite loops for patterns without 'g' flag
        if (!pattern.pattern.global) break;
      }
    }

    return { findings };
  }
}
