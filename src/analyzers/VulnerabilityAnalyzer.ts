import {
  BaseAnalyzer,
  type AnalyzerContext,
  type Finding,
} from '@xorng/template-validator';

/**
 * Security patterns to detect
 */
interface SecurityPattern {
  name: string;
  pattern: RegExp;
  severity: Finding['severity'];
  message: string;
  suggestion: string;
  cwe?: string;
}

/**
 * Common security vulnerability patterns
 */
const SECURITY_PATTERNS: SecurityPattern[] = [
  // SQL Injection
  {
    name: 'sql-injection',
    pattern: /\bexec\s*\(\s*["'`].*?\+|query\s*\(\s*["'`].*?\+|raw\s*\(\s*["'`].*?\+/gi,
    severity: 'critical',
    message: 'Potential SQL injection vulnerability',
    suggestion: 'Use parameterized queries or prepared statements instead of string concatenation',
    cwe: 'CWE-89',
  },
  // Command Injection
  {
    name: 'command-injection',
    pattern: /\bexec\s*\(|execSync\s*\(|spawn\s*\(|spawnSync\s*\(.*\$\{|child_process/gi,
    severity: 'critical',
    message: 'Potential command injection vulnerability',
    suggestion: 'Validate and sanitize all inputs before passing to shell commands',
    cwe: 'CWE-78',
  },
  // Path Traversal
  {
    name: 'path-traversal',
    pattern: /\.\.\//g,
    severity: 'high',
    message: 'Potential path traversal vulnerability',
    suggestion: 'Validate and sanitize file paths, use path.resolve() and check against allowed directories',
    cwe: 'CWE-22',
  },
  // XSS
  {
    name: 'xss-danger',
    pattern: /dangerouslySetInnerHTML|innerHTML\s*=|document\.write\(|\.html\s*\(/gi,
    severity: 'high',
    message: 'Potential XSS vulnerability - unescaped HTML',
    suggestion: 'Sanitize user input before rendering as HTML, use safe rendering methods',
    cwe: 'CWE-79',
  },
  // Hardcoded Secrets
  {
    name: 'hardcoded-secret',
    pattern: /(?:password|secret|api_key|apikey|token|auth)\s*[:=]\s*["'][^"']+["']/gi,
    severity: 'critical',
    message: 'Potential hardcoded secret or credential',
    suggestion: 'Use environment variables or secure secret management',
    cwe: 'CWE-798',
  },
  // Insecure Random
  {
    name: 'insecure-random',
    pattern: /Math\.random\s*\(\)/gi,
    severity: 'medium',
    message: 'Insecure random number generator for security purposes',
    suggestion: 'Use crypto.randomBytes() or crypto.randomUUID() for security-sensitive random values',
    cwe: 'CWE-330',
  },
  // Eval usage
  {
    name: 'eval-usage',
    pattern: /\beval\s*\(|new\s+Function\s*\(/gi,
    severity: 'high',
    message: 'Use of eval() or Function constructor can lead to code injection',
    suggestion: 'Avoid eval() and new Function(). Use JSON.parse() for JSON data',
    cwe: 'CWE-95',
  },
  // Weak Crypto
  {
    name: 'weak-crypto',
    pattern: /createHash\s*\(\s*["'](?:md5|sha1)["']\)|MD5|SHA1(?!.)/gi,
    severity: 'medium',
    message: 'Use of weak cryptographic algorithm',
    suggestion: 'Use SHA-256 or stronger hashing algorithms',
    cwe: 'CWE-327',
  },
  // HTTP without TLS
  {
    name: 'insecure-http',
    pattern: /["']http:\/\/(?!localhost|127\.0\.0\.1)/gi,
    severity: 'medium',
    message: 'Use of insecure HTTP protocol',
    suggestion: 'Use HTTPS for all external communications',
    cwe: 'CWE-319',
  },
  // NoSQL Injection
  {
    name: 'nosql-injection',
    pattern: /\$where|\.find\s*\(\s*\{.*?\$|\.aggregate\s*\(\s*\[.*?\$/gi,
    severity: 'high',
    message: 'Potential NoSQL injection vulnerability',
    suggestion: 'Validate and sanitize query parameters, avoid $where operator',
    cwe: 'CWE-943',
  },
  // SSRF
  {
    name: 'ssrf-potential',
    pattern: /fetch\s*\(\s*(?:req\.|request\.|params\.|query\.)|axios\s*\.\s*(?:get|post)\s*\(\s*(?:req\.|request\.)/gi,
    severity: 'high',
    message: 'Potential Server-Side Request Forgery (SSRF)',
    suggestion: 'Validate and whitelist URLs before making requests',
    cwe: 'CWE-918',
  },
  // Prototype Pollution
  {
    name: 'prototype-pollution',
    pattern: /__proto__|Object\.prototype|constructor\[["']prototype["']\]/gi,
    severity: 'high',
    message: 'Potential prototype pollution vulnerability',
    suggestion: 'Use Object.create(null) for dictionaries, validate object keys',
    cwe: 'CWE-1321',
  },
  // Unvalidated Redirect
  {
    name: 'open-redirect',
    pattern: /res\.redirect\s*\(\s*(?:req\.|request\.|params\.|query\.)/gi,
    severity: 'medium',
    message: 'Potential open redirect vulnerability',
    suggestion: 'Validate redirect URLs against a whitelist',
    cwe: 'CWE-601',
  },
  // Unsafe Deserialization
  {
    name: 'unsafe-deserialization',
    pattern: /JSON\.parse\s*\(\s*(?:req\.|request\.body|Buffer)/gi,
    severity: 'medium',
    message: 'Potential unsafe deserialization',
    suggestion: 'Validate JSON schema before processing parsed data',
    cwe: 'CWE-502',
  },
];

/**
 * Security vulnerability analyzer
 */
export class VulnerabilityAnalyzer extends BaseAnalyzer {
  readonly name = 'vulnerability';
  readonly description = 'Detects common security vulnerabilities';

  private patterns: SecurityPattern[];

  constructor(customPatterns?: SecurityPattern[]) {
    super();
    this.patterns = customPatterns || SECURITY_PATTERNS;
  }

  async analyze(code: string, context: AnalyzerContext): Promise<Finding[]> {
    const findings: Finding[] = [];
    const lines = code.split('\n');

    for (const pattern of this.patterns) {
      // Reset regex lastIndex for global patterns
      pattern.pattern.lastIndex = 0;

      let match: RegExpExecArray | null;
      while ((match = pattern.pattern.exec(code)) !== null) {
        // Find line number
        const beforeMatch = code.substring(0, match.index);
        const lineNumber = beforeMatch.split('\n').length;
        const line = lines[lineNumber - 1] || '';

        // Find column
        const lastNewline = beforeMatch.lastIndexOf('\n');
        const column = match.index - (lastNewline + 1);

        findings.push({
          id: crypto.randomUUID(),
          type: 'security',
          severity: pattern.severity,
          message: pattern.message,
          file: context.filePath,
          line: lineNumber,
          column,
          code: line.trim(),
          suggestion: pattern.suggestion,
          rule: pattern.name,
          metadata: pattern.cwe ? { cwe: pattern.cwe } : undefined,
        });

        // Prevent infinite loops for patterns without 'g' flag
        if (!pattern.pattern.global) break;
      }
    }

    return findings;
  }
}
